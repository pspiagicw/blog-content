<!DOCTYPE html>
<html lang="en-us">

<head>
    <title>
Tree-Sitting | pspiagicw
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="generator" content="Hugo 0.123.8">


<link rel="canonical" href="/posts/treesitting/" >
<link href="/sass/main.min.bd19d955a59805faafd36e2c4ce339deccbea14f3a0977897c5226c5fd96eda7.css" rel="stylesheet">



</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a href="/">
                <span class="terminal">pspiagicw@falconite ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="/" title="" >
                        ~/home</a>
                </li>
                
                <li>
                    <a href="/posts" title="" >
                        ~/writing</a>
                </li>
                
                <li>
                    <a href="/about" title="" >
                        ~/about</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
    <h1>Tree-Sitting</h1>
    
    <section class="postMetadata">
        <dl>
            
                
<dt>tags</dt>
<dd><span></span>
    <a href="/tags/linux/">#Linux</a><span></span>
    <a href="/tags/emacs/">#Emacs</a><span></span>
    <a href="/tags/neovim/">#Neovim</a><span></span>
    <a href="/tags/editors/">#Editors</a></dd>
            
            
            
                
<dt>categories</dt>
<dd><span></span>
    <a href="/categories/editors/">Editors</a></dd>
            
            
                <dt>published</dt>
                
                <dd><time datetime="2024-03-25">March 25, 2024</time></dd>
            
            
                <dt>reading time</dt>
                <dd>17 minutes</dd>
            
        </dl>
    </section>
    
    <div>
        <p>This is a post on how I wrote a tree-sitter parser for a new language. and how I integrated it into my editor.</p>
<p>The new language being my toy language, <a href="https://github.com/pspiagicw/hotshot">hotshot</a>.
This language is a LISP-like scripting language.</p>
<p>Here is a snippet of the language:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">fn</span> fibonacci (<span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">cond </span>((&lt; n <span style="color:#ae81ff">1</span>) <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        ((= n <span style="color:#ae81ff">1</span>) <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">true</span> (+ (<span style="color:#a6e22e">fibonacci</span> (- n <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>                 (<span style="color:#a6e22e">fibonacci</span> (- n <span style="color:#ae81ff">2</span>))))))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">assert</span> (<span style="color:#a6e22e">fibonacci</span> <span style="color:#ae81ff">7</span>) <span style="color:#ae81ff">13</span> <span style="color:#e6db74">&#34;fibonacci failed&#34;</span>)
</span></span><span style="display:flex;"><span>(<span style="color:#a6e22e">assert</span> (<span style="color:#a6e22e">fibonacci</span> <span style="color:#ae81ff">10</span>) <span style="color:#ae81ff">55</span> <span style="color:#e6db74">&#34;fibonacci failed&#34;</span>)
</span></span></code></pre></div><p>Notice how the syntax highlighting is pretty shit.</p>
<p>By the end of this post, you will be able to fix just that (Atleast in your editor)</p>
<hr>
<p>Before:
<img src="/images/tree-sitting/before.png" alt="Before"></p>
<p>After:
<img src="/images/tree-sitting/after.png" alt="After"></p>
<hr>
<h2 id="tree-sitter"><code>Tree-Sitter</code></h2>
<p>I like using <code>neovim</code>.</p>
<p>Editors like <code>neovim</code> including <code>emacs</code>, <code>kakoune</code> and <code>helix</code> use the <code>tree-sitter</code> library for syntax highlighting.</p>
<p>Developed for the <code>atom</code> editor, it&rsquo;s a incremental parsing library that can perform syntax highlighting, indentation and other wizardry.</p>
<p>It is faster and more accurate than the traditional regex-based highlighting/identation.</p>
<p>My previous post on the <a href="https://falconite.xyz/posts/microservices-and-editors/">composition of editors</a> has more info on it&rsquo;s working.</p>
<p>See the <a href="https://tree-sitter.github.io/tree-sitter">tree-sitter official docs</a> for complete information.</p>
<hr>
<h2 id="dependencies"><code>Dependencies</code></h2>
<p>You will need</p>
<ul>
<li>
<p>Node (The <code>docs</code> mention <code>v6.0</code> or higher, but my advice is to use the latest version)</p>
</li>
<li>
<p><code>tree-sitter-cli</code>, my advice is to download the latest version from the <a href="https://github.com/tree-sitter/tree-sitter/releases">release page</a>.</p>
</li>
</ul>
<p>You can also install <code>tree-sitter-cli</code> from <code>npm</code>, and you will have to configure your PATH to include the <code>node_modules/.bin</code> directory.</p>
<hr>
<h2 id="getting-started"><code>Getting Started</code></h2>
<ul>
<li>Create a directory called <code>tree-sitter-hotshot</code>.</li>
<li>Inside this directory, create a <code>grammar.js</code> file.</li>
</ul>
<p>You can get started with te following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// grammar.js 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">grammar</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// name of your language
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hotshot&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rules</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">source_file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#e6db74">&#39;hello&#39;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><hr>
<h2 id="grammar"><code>Grammar</code></h2>
<p>Tree-Sitter grammar works on <code>rules</code>. A <code>rule</code> in essence is</p>
<ul>
<li>
<p>A regex to match with text in the source file</p>
</li>
<li>
<p>A combination of other rules (More on that later)</p>
</li>
<li>
<p>A string to match with text.</p>
</li>
</ul>
<p>Tree-Sitter needs only a single rule <code>source_file</code> to declared.
It will start parsing the source code according to this rule.</p>
<p><em>It helps if you are familiar with <code>BNF</code> forms or used <code>ANTLR</code>/<code>bison</code>/<code>yacc</code></em></p>
<p>The grammar currently has a single rule, that matches the text <code>hello</code>.</p>
<p>Generate the parser by running the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>tree-sitter generate
</span></span></code></pre></div><p>It should create a shitload of files in the current directory.</p>
<p>You never have to directly interact with these files, tree-sitter manages these for us.</p>
<p>Although these are important files for the future. If you are using <code>git</code> add them into the repository.</p>
<p>The important files are</p>
<ul>
<li><code>grammar.js</code></li>
<li><code>package.json</code></li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<hr>
<h2 id="writing-the-grammar"><code>Writing the Grammar</code></h2>
<h3 id="expression"><code>expression</code></h3>
<p>In my language, most statement returns some value.</p>
<p>It can have a single <code>string</code>, <code>boolean</code> or <code>integer</code> as a statement.</p>
<p>Example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span><span style="color:#75715e">; this is a coment BTW :) ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;hello world&#34;</span> <span style="color:#75715e">; =&gt; return &#34;hello world&#34;;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69</span> <span style="color:#75715e">; =&gt; return 69 ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true <span style="color:#75715e">; =&gt; return true ;</span>
</span></span></code></pre></div><p>Let&rsquo;s add support for <code>integer</code>, we can add support for other types incrementally.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">grammar</span>({
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hotshot&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rules</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Source file has multiple statement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">source_file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Statement can have a expression
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">statement</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Expression can have a integer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">expression</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">integer</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Regex
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">integer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">d</span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">/</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><ul>
<li>
<p>Rules are declared  with the syntax <code>rule_name: $ =&gt; &lt;rule-content&gt;</code>.</p>
</li>
<li>
<p>Rules are referenced with syntax <code>$.&lt;rule-name&gt;</code>.</p>
</li>
</ul>
<p>The above grammar includes special functions like <code>repeat</code> and <code>choice</code>.</p>
<ul>
<li>
<p><code>repeat</code> means the child rule can occur zero or more times.</p>
</li>
<li>
<p><code>choice</code> means only one of the child rules will be matched</p>
</li>
</ul>
<p>In essence it means,</p>
<ul>
<li>
<p>a <code>source_file</code> can have zero or more <code>statement</code>.</p>
</li>
<li>
<p>a <code>statement</code> can be of type <code>expression</code></p>
</li>
<li>
<p>a <code>expression</code> can be of type <code>integer</code></p>
</li>
<li>
<p>a <code>integer</code> consists of consecutive one or more digits.</p>
</li>
</ul>
<p>The <code>integer</code> rule uses <code>Regular Expressions</code>, to declare one or more consecutive digits to be a <code>integer</code>.</p>
<p><em>If you want to implement rules in <code>tree-sitter</code>, you need to be comfortable with <code>regex</code></em></p>
<hr>
<h2 id="a-friendly-tip"><code>A friendly tip!</code></h2>
<p>There are multiple times in this post, you will be required to use <code>tree-sitter</code> to test and parse source code.</p>
<p>It goes without saying, you need to run <code>tree-sitter generate</code> each time, before doing any testing or parsing.</p>
<hr>
<h3 id="testing-the-parser"><code>testing the parser</code></h3>
<p>We can write a few <code>hotshot</code> programs to test if the parsing is accurate.</p>
<p>Save this under <code>programs/integer.ht</code>. We will use the <code>programs</code> directory to store example files.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#ae81ff">420</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69</span>
</span></span></code></pre></div><hr>
<p><em>Tree-Sitter has a full fledged testing framework embedded into it.
But it&rsquo;s not recommended for beginners. It is also quite not useful for such a small grammar.</em></p>
<p><em>You can refer it <a href="https://tree-sitter.github.io/tree-sitter/creating-parsers#command-test">here</a> later</em></p>
<hr>
<p>We will be using a simple command to test the parser.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Parses all `hotshot` programs and prints only the stats</span>
</span></span><span style="display:flex;"><span>tree-sitter parse --quiet --stat programs/*.ht
</span></span></code></pre></div><p>To test a single file run</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#75715e"># Replace `programs/integer.ht` with your file</span>
</span></span><span style="display:flex;"><span>tree-sitter parse programs/integer.ht
</span></span></code></pre></div><p>It should output</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>]
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>])))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>]))))
</span></span></code></pre></div><p>You can clearly see the AST built for our language here.</p>
<hr>
<h3 id="comments"><code>comments</code></h3>
<p>We can add support for comments by adding the following rule to the grammar:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">grammar</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hotshot&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">extras</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; [<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">comment</span>, <span style="color:#e6db74">/\s/</span>], <span style="color:#75715e">// Add this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rules</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">source_file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Add this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">comment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span>;[<span style="color:#f92672">^</span>;]<span style="color:#f92672">*</span>;<span style="color:#960050;background-color:#1e0010">/</span>
</span></span><span style="display:flex;"><span>   }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><ul>
<li>
<p>The <code>extras</code> rule is used to specify the tokens that are not part of the syntax tree, but are still important for the parser.</p>
</li>
<li>
<p>The <code>/\s/</code> means all the whitespace characters like space, tabs and newlines.</p>
</li>
</ul>
<p><code>hotshot</code> supports <code>inline</code> comments. Meaning <code>(+ 1 ;some comments here; 2)</code> is a valid statement.</p>
<p>That&rsquo;s the reason I have added <code>comments</code> to the <code>extras</code> field.</p>
<p>If your language integrates comments into the syntax tree, you can add it to the <code>statement</code> rule.</p>
<hr>
<h3 id="more-expressions"><code>more expressions</code></h3>
<p>Now that we have added support for <code>integers</code> and <code>comments</code>, we can add support for <code>strings</code> and <code>booleans</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">expression</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">integer</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">string</span>
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">integer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">d</span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">/,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">string</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span><span style="color:#e6db74">&#34;[^&#34;</span>]<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#f92672">/</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">boolean</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;true&#39;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;false&#39;</span>
</span></span><span style="display:flex;"><span>      )
</span></span><span style="display:flex;"><span><span style="color:#75715e">//....
</span></span></span></code></pre></div><p>Here&rsquo;s a example code that has all types of expressions, along with comments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; this is a comment ;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; programs/data.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">69</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;this is a string&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>true
</span></span><span style="display:flex;"><span>false
</span></span></code></pre></div><p>If you run <code>tree-sitter parse programs/data.ht</code>. You should get a output like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">9</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">comments</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>])
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">comments</span> [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>])
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>   (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>]
</span></span><span style="display:flex;"><span>     (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>])))
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>]
</span></span><span style="display:flex;"><span>   (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>]
</span></span><span style="display:flex;"><span>     (string [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>])))
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>   (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>     (<span style="color:#a6e22e">boolean</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>])))
</span></span><span style="display:flex;"><span> (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>   (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>     (<span style="color:#a6e22e">boolean</span> [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>]))))
</span></span></code></pre></div><hr>
<p><em>If comments are not part of the AST, why are they parsed?</em></p>
<p>They are parsed because they are still important to the source code.
Features like syntax highlighting and indentation still apply to comments.</p>
<hr>
<h3 id="hello-world"><code>hello-world</code></h3>
<p>Let&rsquo;s add support for the most overrated program of all time, the <code>hello-world</code> program.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/hello-world.ht ;</span>
</span></span><span style="display:flex;"><span>(echo <span style="color:#e6db74">&#34;Hello, World!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;`echo` is a built-in function in `hotshot`. ;</span>
</span></span></code></pre></div><p>If you run the test before writing the actual rules.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tree-sitter parse programs/hello-world.ht
</span></span></code></pre></div><p>It gives an error, because we haven&rsquo;t added support for <code>function calls</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">ERROR</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">ERROR</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>])))
</span></span><span style="display:flex;"><span>programs/hello-world<span style="color:#f92672">.</span>ht    <span style="color:#ae81ff">0.02</span> ms         <span style="color:#ae81ff">909</span> bytes/ms (<span style="color:#a6e22e">ERROR</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>])
</span></span></code></pre></div><p>Function calls in <code>hotshot</code> are represented by the following syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(function-name arg1 arg2 arg3)
</span></span></code></pre></div><p>Add the following code. It has quite a few rules, but don&rsquo;t fret.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">statement</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// Paren statement
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">sparen</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Paren Statement =&gt; &#39;(&#39;, paren ,&#39;)&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">sparen</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">paren</span> ,<span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fcall</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fname</span>), <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;argument&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">returnable</span>))),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">expression</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">integer</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">string</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fname</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">identifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span>[<span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#a6e22e">zA</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Z</span>]<span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">/,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ...
</span></span></span></code></pre></div><ul>
<li>
<p>The above code introduces the tree-sitter function <code>seq</code>.</p>
<p>This dictates a sequence of rules, in a specific order.</p>
</li>
<li>
<p>It also has the <code>field</code> function.</p>
<p>This function tags the child rule with a name, that we can see in the AST.</p>
</li>
<li>
<p>The code adds rules for <code>identifiers</code> (variables).</p>
</li>
<li>
<p>Identifiers are defined as a sequence of one or more alphabets.</p>
</li>
</ul>
<hr>
<p><code>returnables</code> are different from <code>statements</code>.</p>
<p><code>hotshot</code> has few statements that aren&rsquo;t supposed to evaluate into values, like function declaration etc.</p>
<p>They will be syntax highlighted differently thus separating them from other expressions is required.</p>
<p>I have made separate rule for those that evaluate to values.</p>
<hr>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">27</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">sparen</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">paren</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">fname</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>]))
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">returnable</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>              (string [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]))))))))
</span></span></code></pre></div><hr>
<p>If you can see, we have a lot of <code>psuedo</code> nodes, like <code>sparen</code>, <code>paren</code>, <code>fname</code>.</p>
<p>In tree-sitter syntax, you can add a <code>_</code> in front of a rule to make it a <code>hidden</code> rule.</p>
<p>Here&rsquo;s the entire grammar with the hidden rules.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">module</span>.<span style="color:#a6e22e">exports</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">grammar</span>({
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;hotshot&#39;</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">extras</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; [<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">comment</span>, <span style="color:#e6db74">/\s/</span>],
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rules</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">source_file</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">statement</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_sparen</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_sparen</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_paren</span> ,<span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fcall</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_fname</span>), <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;argument&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_returnable</span>))),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">expression</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">integer</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">boolean</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">string</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_fname</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">integer</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#a6e22e">d</span><span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">/,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">boolean</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(<span style="color:#e6db74">&#39;true&#39;</span>, <span style="color:#e6db74">&#39;false&#39;</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">identifier</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span>[<span style="color:#a6e22e">a</span><span style="color:#f92672">-</span><span style="color:#a6e22e">zA</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Z</span>]<span style="color:#f92672">+</span><span style="color:#960050;background-color:#1e0010">/,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">string</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span><span style="color:#e6db74">&#34;[^&#34;</span>]<span style="color:#f92672">*</span><span style="color:#960050;background-color:#1e0010">&#34;</span><span style="color:#f92672">/</span>,
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">comment</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#f92672">/</span>;[<span style="color:#f92672">^</span>;]<span style="color:#f92672">*</span>;<span style="color:#960050;background-color:#1e0010">/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The <code>hello-world</code> program should parse much cleanly now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">27</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">1</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>      name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>])
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>        (string [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>])))))
</span></span></code></pre></div><hr>
<h3 id="let"><code>let</code></h3>
<p>Let&rsquo;s examine the <code>let</code> statement</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span>(<span style="color:#66d9ef">let</span> a <span style="color:#ae81ff">1</span>)
</span></span></code></pre></div><p>This statement can be parsed as <code>(function-call arg1 arg2)</code>, which is kinda wrong syntax wise.</p>
<p>It&rsquo;s a separate statement altogether, not a function-call. I want it selected and syntax-highlighted as a separate statement.</p>
<p>But if I put <code>fcall</code> as a expression, there would no way of differenciating the <code>let</code> statement from any other <code>function call</code></p>
<p>It&rsquo;s the reason I added the <code>returnable</code> , <code>sparen</code> and <code>paren</code> rules.</p>
<p>There is way to prevent adding them.</p>
<p><em>It&rsquo;s to use precedence in defining rules.
It tells tree-sitter to give precedence to one kind of statements over another.</em></p>
<p>But <code>precedence</code> is a big topic and a overkill for such a simple language.</p>
<p>For the <code>let</code> statements, add the following code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">// ..
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>, <span style="color:#75715e">// Don&#39;t forget this comma
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span> <span style="color:#75715e">// Add this line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// rule for &#39;let&#39; statements.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;let&#39;</span>, <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>), <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;value&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>)),
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//.. 
</span></span></span></code></pre></div><p>Write the test program to parse.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/variables.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">let</span> a <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(echo a)
</span></span></code></pre></div><p>It should produce the following AST.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">let </span>[<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>      name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>])
</span></span><span style="display:flex;"><span>      value: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>]
</span></span><span style="display:flex;"><span>      name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>])
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>])))))
</span></span></code></pre></div><hr>
<h3 id="control-flow"><code>control-flow</code></h3>
<p>Now that we have added support for <code>let</code> statements, we can add support for <code>control-flow</code> statements.</p>
<p>This includes <code>if</code>, <code>cond</code> and <code>while</code> statements.</p>
<p>We can skim over these quite quickly as they are easy to implement and test.</p>
<hr>
<h3 id="if"><code>if</code></h3>
<p><code>if</code> statements in <code>hotshot</code> have a simple syntax.
Both the <code>body</code> and <code>else</code> have a single statement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#66d9ef">if </span>condition body-statement else-statement)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">; The else part is optional ;</span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">if </span>condition body-statement)
</span></span></code></pre></div><ul>
<li>Test Program</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/if.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">if</span> true
</span></span><span style="display:flex;"><span>  (echo <span style="color:#e6db74">&#34;true&#34;</span>)
</span></span><span style="display:flex;"><span>  (echo <span style="color:#e6db74">&#34;false&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">if</span> (somefunction) <span style="color:#e6db74">&#34;true&#34;</span>)
</span></span></code></pre></div><ul>
<li>Code</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span>
</span></span><span style="display:flex;"><span>     ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">if</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(
</span></span><span style="display:flex;"><span>       <span style="color:#e6db74">&#39;if&#39;</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;condition&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_returnable</span>),
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;body&#39;</span>,<span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">optional</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;else&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>)
</span></span><span style="display:flex;"><span>     )),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// If statements can return value, thus add them into returnable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span></code></pre></div><ul>
<li>
<p>The above code has a new function <code>optional</code>.</p>
<p>This function makes it&rsquo;s argument optional.
Cause a <code>if</code> statement might not have a <code>else</code> part.</p>
</li>
<li>
<p>Output</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">17</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">if </span>[<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>      condition: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">boolean</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>]))
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>]))))
</span></span><span style="display:flex;"><span>      else: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>]))))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">26</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">if </span>[<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>]
</span></span><span style="display:flex;"><span>      condition: (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">17</span>]
</span></span><span style="display:flex;"><span>        name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">17</span>]))
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>]
</span></span><span style="display:flex;"><span>          (string [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>]))))))
</span></span></code></pre></div><hr>
<h3 id="while"><code>while</code></h3>
<p><code>while</code> statements in <code>hotshot</code> have the following syntax.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">while</span> condition body)
</span></span></code></pre></div><ul>
<li>The <code>body</code> is a single statement to execute. A <code>while</code> statement can return something.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/while.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(while true
</span></span><span style="display:flex;"><span>    (echo <span style="color:#e6db74">&#34;Infinity!&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(while isTrue
</span></span><span style="display:flex;"><span> (do
</span></span><span style="display:flex;"><span>  (<span style="color:#66d9ef">let</span> isTrue (checkSomething))
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;It&#39;s true&#34;</span>))
</span></span></code></pre></div><ul>
<li>Code</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;while&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;condition&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_returnable</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;body&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Believe it or not, while statement are returnable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">9</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">while</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>      condition: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">boolean</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>]))
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]))))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">while</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>]
</span></span><span style="display:flex;"><span>      condition: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]))
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>            name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>])
</span></span><span style="display:flex;"><span>            argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]
</span></span><span style="display:flex;"><span>              (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]))
</span></span><span style="display:flex;"><span>            argument: (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>]
</span></span><span style="display:flex;"><span>              name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>])))
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2</span>] - [<span style="color:#ae81ff">8</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>])))))))
</span></span></code></pre></div><hr>
<h3 id="cond"><code>cond</code></h3>
<p><code>cond</code> is a tricky statement.</p>
<p>It&rsquo;s syntax is this</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">cond</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">condition1</span> body1)
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">condition2</span> body2))
</span></span></code></pre></div><ul>
<li>The <code>condition</code> is a <code>returnable</code> expression. The body is a single <code>statement</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/cond.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(cond
</span></span><span style="display:flex;"><span>    ((condition1) <span style="color:#e6db74">&#34;condition1 is true&#34;</span>)
</span></span><span style="display:flex;"><span>    ((condition2) <span style="color:#e6db74">&#34;condition2 is true&#34;</span>)
</span></span><span style="display:flex;"><span>    (true <span style="color:#e6db74">&#34;nothing is true&#34;</span>))
</span></span></code></pre></div><ul>
<li>Code</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">cond</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cond</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;cond&#39;</span>, <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;argument&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">carg</span>))),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">carg</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>,<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;condition&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">_returnable</span>), <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;body&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>), <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">cond</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//....
</span></span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">7</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">cond </span>[<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">28</span>]
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">carg</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        condition: (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>])))
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]
</span></span><span style="display:flex;"><span>          (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]))))
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">carg</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">39</span>]
</span></span><span style="display:flex;"><span>        condition: (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">6</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">integer</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">16</span>])))
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]
</span></span><span style="display:flex;"><span>          (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">38</span>]))))
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">carg</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">28</span>]
</span></span><span style="display:flex;"><span>        condition: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>]
</span></span><span style="display:flex;"><span>          (<span style="color:#a6e22e">boolean</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">5</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>]))
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">27</span>]
</span></span><span style="display:flex;"><span>          (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">27</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">27</span>])))))))
</span></span></code></pre></div><hr>
<h3 id="functions"><code>functions</code></h3>
<p>Now that we have added support for <code>control-flow</code> statements, we can add support for function declaration.</p>
<p>This also includes <code>lambda</code> functions.</p>
<p>Functions have the following syntax</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">fn</span> function-name (<span style="color:#a6e22e">param1</span> param2) body)
</span></span></code></pre></div><ul>
<li><code>function-name</code> is a <code>identifier</code></li>
<li><code>paramN</code> is a <code>identifier</code></li>
<li><code>body</code> is a single statement</li>
</ul>
<p>Example</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/functions.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(fn hello() (echo <span style="color:#e6db74">&#34;Say hello&#34;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(fn add (x y) (add x y))
</span></span></code></pre></div><ul>
<li>Code</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">cond</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fdec</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fdec</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;fn&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;(&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;parameter&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>)),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;)&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;body&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">25</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">31</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">fdec</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>      name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>])
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">12</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">30</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">17</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>]
</span></span><span style="display:flex;"><span>            (string [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">2</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">29</span>]))))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">fdec</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>      name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">7</span>])
</span></span><span style="display:flex;"><span>      parameter: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">8</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>])
</span></span><span style="display:flex;"><span>      parameter: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>])
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">13</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">17</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>]))
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>] - [<span style="color:#ae81ff">4</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>])))))))
</span></span></code></pre></div><hr>
<h3 id="lambda"><code>lambda</code></h3>
<p><code>lambda</code> is a name-less function.</p>
<p>It&rsquo;s main function is to pass it around as a argument, to be used by other functions like <code>map</code>, <code>filter</code> etc.</p>
<p>You can bind it to a variable, meaning it is a <code>returnable</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-lisp" data-lang="lisp"><span style="display:flex;"><span><span style="color:#75715e">; programs/lambda.ht ;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(lambda () <span style="color:#e6db74">&#34;something&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(lambda (x y) (add x y))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>(<span style="color:#66d9ef">let</span> a (lambda () <span style="color:#e6db74">&#34;something&#34;</span>))
</span></span></code></pre></div><ul>
<li>The code is similar to <code>fdec</code>, but excludes the name of the function.</li>
<li>Also it&rsquo;s a <code>returnable</code>, unlike <code>fdec</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">_paren</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">let</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">cond</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fdec</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">lambda</span>
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lambda</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">seq</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;lambda&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;(&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">repeat</span>(<span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;argument&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">identifier</span>)),
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#39;)&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">field</span>(<span style="color:#e6db74">&#39;body&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">statement</span>),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_returnable</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">$</span> =&gt; <span style="color:#a6e22e">choice</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">expression</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">fcall</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">if</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#66d9ef">while</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">cond</span> , <span style="color:#e6db74">&#39;)&#39;</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">seq</span>(<span style="color:#e6db74">&#39;(&#39;</span>, <span style="color:#a6e22e">$</span>.<span style="color:#a6e22e">lambda</span> , <span style="color:#e6db74">&#39;)&#39;</span>)
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//...
</span></span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scheme" data-lang="scheme"><span style="display:flex;"><span>(<span style="color:#a6e22e">source_file</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">6</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">comment</span> [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>])
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">lambda </span>[<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>          (string [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>] - [<span style="color:#ae81ff">3</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>])))))
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">24</span>]
</span></span><span style="display:flex;"><span>    (<span style="color:#66d9ef">lambda </span>[<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">1</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>]
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">9</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">10</span>])
</span></span><span style="display:flex;"><span>      argument: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">11</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">12</span>])
</span></span><span style="display:flex;"><span>      body: (<span style="color:#a6e22e">statement</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">14</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">23</span>]
</span></span><span style="display:flex;"><span>        (<span style="color:#a6e22e">fcall</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>          name: (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">15</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">18</span>])
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">19</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">20</span>]))
</span></span><span style="display:flex;"><span>          argument: (<span style="color:#a6e22e">expression</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>]
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">identifier</span> [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">21</span>] - [<span style="color:#ae81ff">5</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">22</span>])))))))
</span></span></code></pre></div><hr>
<h2 id="testing"><code>testing</code></h2>
<p>Ensure all the programs we wrote earlier are still parsing correctly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tree-sitter parse --quiet --stat programs/*.ht
</span></span></code></pre></div><p>It should give the following output.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>Total parses: 9; successful parses: 9; failed parses: 0; success percentage: 100.00%; average speed: 6000 bytes/ms
</span></span></code></pre></div><hr>
<h2 id="end"><code>end</code></h2>
<p>We have successfully implemented the parsing of a LISP-like language.</p>
<p>Parsing is useless if don&rsquo;t do anything with the AST.</p>
<p>We can implement</p>
<ul>
<li>Syntax Highlighting</li>
<li>Indentation</li>
<li>Select parts of code using tree-sitter queries.</li>
</ul>
<p>But there are some advantages to writing a tree-sitter parser like this.</p>
<ul>
<li>
<p>You can prototype your own language quickly using <code>tree-sitter</code> before writing a handwritten lexer/parser.</p>
</li>
<li>
<p>Having syntax highlighting to your custom language is useful while developing a <code>interpreter</code> or a <code>compiler</code> for it.</p>
</li>
</ul>
<p>BTW <a href="https://github.com/pspiagicw/tree-sitter-hotshot">Hotshot&rsquo;s Tree-Sitter</a> can be referenced for the entire code.</p>
<hr>
<h2 id="next-post"><code>next-post</code></h2>
<p>We will learn how to implement <code>syntax-highlighting</code> along with tree-sitter <code>queries</code></p>
<p>We will also see how <code>nvim-treesitter</code> works with the <code>tree-sitter</code> library.</p>
<hr>
<h2 id="references"><code>references</code></h2>
<p>If want to make anything other than a <code>toy</code> langauge refer to these babes below.</p>
<ul>
<li>
<p><a href="https://tree-sitter.github.io/tree-sitter">official tree-sitter docs</a></p>
<p>Covers literally everything</p>
</li>
<li>
<p><a href="https://siraben.dev/2022/03/01/tree-sitter.html">Ben&rsquo;s Musing</a></p>
<p>Covers precedence, associativity, actual tree-sitter tests etc.</p>
</li>
<li>
<p><a href="https://www.jonashietala.se/blog/2024/03/19/lets_create_a_tree-sitter_grammar/">Jonas Hietala</a></p>
<p>Covers making custom scanners, embedding tree-sitter etc.</p>
</li>
</ul>

    </div>
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>Made with ♥  using Hugo.</span>
    
</footer>
    </div>

</body>

</html>